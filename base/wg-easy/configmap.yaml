apiVersion: v1
kind: ConfigMap
metadata:
  name: wg-easy-startup
  namespace: wg-easy
  labels:
    app.kubernetes.io/name: wg-easy
    app.kubernetes.io/component: vpn
    app.kubernetes.io/managed-by: kustomize
data:
  startup.sh: |
    #!/bin/sh
    set -e

    echo "Starting wg-easy with Talos Linux compatibility..."

    # Start wg-easy in background
    node server/index.mjs &
    WGEASY_PID=$!

    # Wait for wg-easy to fully initialize and fail to start WireGuard
    # This ensures wg0.conf is in its final state before we patch it
    echo "Waiting for wg-easy initialization to complete..."
    sleep 10

    # Monitor and patch wg0.conf whenever it changes
    echo "Starting configuration patcher..."
    while kill -0 $WGEASY_PID 2>/dev/null; do
      if [ -f /etc/wireguard/wg0.conf ]; then
        # Check if file contains iptables commands (needs patching)
        if grep -q "^PostUp = iptables" /etc/wireguard/wg0.conf; then
          echo "Detected iptables config, applying Talos compatibility patch..."
          sed -i 's/^PostUp = iptables.*/PostUp = echo "WireGuard interface up"/' /etc/wireguard/wg0.conf
          sed -i 's/^PostDown = iptables.*/PostDown = echo "WireGuard interface down"/' /etc/wireguard/wg0.conf

          # Restart WireGuard interface with patched config
          echo "Restarting WireGuard interface..."
          wg-quick down wg0 2>/dev/null || true
          wg-quick up wg0 && echo "WireGuard interface started successfully"
        fi
      fi
      sleep 5
    done

    # Wait for main process to exit
    wait $WGEASY_PID
